\documentclass[11pt]{beamer}
\usetheme{Dresden}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[backend=bibtex]{biblatex}
\usepackage{cancel}
\usepackage{minted}
\addbibresource{talkslides.bib}

\author{Mitchell Riley}
\title{Exact Real Arithmetic in Haskell}
\date{12th May 2015}
\beamertemplatenavigationsymbolsempty
\setbeamertemplate{footline}{}
\begin{document}

\begin{frame}
\titlepage
\end{frame}

\section{Intro}

\begin{frame}
\frametitle{Floating point}
\begin{align*}
\begin{pmatrix}
64919121   & -159018721 \\
41869520.5 & -102558961
\end{pmatrix} x =
\begin{pmatrix}
1 \\
0
\end{pmatrix}
\end{align*}
\end{frame}

\begin{frame}[fragile]
\begin{minted}{haskell}
solveAxb :: Fractional t =>
            (t, t, t, t) -> (t, t) -> (t, t)
solveAxb (a11, a12,
          a21, a22)
         (b1,
          b2)
  = (( a22 * b1 - a12 * b2) / det,
     (-a21 * b1 + a11 * b2) / det)
  where det = a11 * a22 - a12 * a21

a :: Fractional t => (t, t, t, t)
a = (64919121,   -159018721,
     41869520.5, -102558961)

b :: Fractional t => (t, t)
b = (1,
     0)
\end{minted}
\end{frame}

\begin{frame}
Using \texttt{Double}s:
\begin{align*}
x =
\begin{pmatrix}
102558961 \\
41869520.5
\end{pmatrix}
\end{align*}
\pause
Actually...
\begin{align*}
x =
\begin{pmatrix}
205117922 \\
83739041
\end{pmatrix}
\end{align*}
\end{frame}


\begin{frame}
\frametitle{Almost integers}
\texttt{Double}s:
\only<1>{\begin{align*}
\sin(2017 \sqrt[5]{2}) = -1
\end{align*}}
\only<2->{\begin{align*}\xcancel{
\sin(2017 \sqrt[5]{2}) = -1
}
\end{align*}}
\pause
Actually:
\begin{align*}
\sin(2017 \sqrt[5]{2}) = -0.9999999999999999785
\end{align*}
\end{frame}

\begin{frame}
\frametitle{Arbitrary precision arithmetic}
Arbitrary precision \emph{integer} arithmetic comes built in to
Haskell (and Python and Ruby and ...)
\\~\\
Can use this to implement arbitrary precision floating point, i.e. $n
\times b^c$
\\~\\
Doesn't save us with \texttt{sqrt}, \texttt{sin}, \texttt{pi} ...
\end{frame}

\begin{frame}
\frametitle{\emph{Exact} arithmetic}
Represents any (computable) real number \emph{exactly}
\\~\\
Transcendental functions in \texttt{Floating} are no longer approximations
\\~\\
We are able to request any output precision, and the details are
handled for us
\end{frame}

%\section{Fast Cauchy}

\section{Continued Fractions}

\begin{frame}
\frametitle{Decimal representation}
Consider $\pi$:
\only<1>{\begin{align*}
\pi = 3
\end{align*}}
\only<2>{\begin{align*}
\pi = 3 + 0.1415926\dots
\end{align*}}
\only<3>{\begin{align*}
\pi = 3 + \frac{1}{10}(1)
\end{align*}}
\only<4>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + 0.415926\dots)
\end{align*}}
\only<5>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + \frac{1}{10}(4))
\end{align*}}
\only<6>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + \frac{1}{10}(4 + 0.15926\dots))
\end{align*}}
\only<7>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + \frac{1}{10}(4 + \frac{1}{10}(1)))
\end{align*}}
\only<8>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + \frac{1}{10}(4 + \frac{1}{10}(1 + 0.5926\dots)))
\end{align*}}
\only<9>{\begin{align*}
\pi = 3 + \frac{1}{10}(1 + \frac{1}{10}(4 + \frac{1}{10}(1 + \frac{1}{10}(5 + \dots))))
\end{align*}}
\end{frame}

\begin{frame}[fragile]
\frametitle{Decimal representation}
Consider $\pi$:
\begin{align*}
\pi &= 3.1415\dots \\
&= 3 + \frac{1}{10^1} + \frac{4}{10^2} + \frac{1}{10^3} + \frac{5}{10^4} + \dots
\end{align*}

\begin{minted}{haskell}
decimal :: RealFrac a => a -> [Integer]
decimal a = let d = floor a in
            d : decimal ((a - fromInteger d) * 10)

decimal (1%3) => [0,3,3,3,3,3,3,...
decimal pi    => [3,1,4,1,5,9,2,...
\end{minted}
\end{frame}

\begin{frame}
\frametitle{Decimal representation}
Some problems:
\begin{align*}
\frac{1}{3} = 0.333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333\dots
\end{align*}
\\~\\
Implementing \texttt{Floating} on a stream of decimal digits
would be nasty
\\~\\
Why the 10?!
\end{frame}

\begin{frame}
\frametitle{Continued fractions}
Consider $\pi$:
\only<1>{\begin{align*}
\pi = 3
\end{align*}}
\only<2>{\begin{align*}
\pi = 3 + 0.1415926\dots
\end{align*}}
\only<3>{\begin{align*}
\pi = 3 + \frac{1}{7}
\end{align*}}
\only<4>{\begin{align*}
\pi = 3 + \frac{1}{7 + 0.0625132\dots}
\end{align*}}
\only<5>{\begin{align*}
\pi = 3 + \frac{1}{7 + \frac{1}{15}}
\end{align*}}
\only<6>{\begin{align*}
\pi = 3 + \frac{1}{7 + \frac{1}{15 + 0.9965996}\dots}
\end{align*}}
\only<7>{\begin{align*}
\pi = 3 + \frac{1}{7 + \frac{1}{15 + \frac{1}{1}}}
\end{align*}}
\only<8>{\begin{align*}
\pi = 3 + \frac{1}{7 + \frac{1}{15 + \frac{1}{1 + 0.0034172\dots}}}
\end{align*}}
\only<9>{\begin{align*}
\pi = 3 + \frac{1}{7 + \frac{1}{15 + \frac{1}{1 + \frac{1}{292 + \dots}}}}
\end{align*}}
\end{frame}

\begin{frame}[fragile]
Let us write this as $\pi = [3,7,15,1,292,\dots]$
\\~\\
\begin{minted}{haskell}
cf :: Fractional a => a -> [Integer]
cf a = let d = floor a in
       d : cf (recip (a - fromInteger d))

cf (1%3) => [0,3]
cf pi    => [3,7,15,1,292,...
\end{minted}
Every real number has a finite, (essentially) unique expansion
\\~\\
This expansion is finite when the number is rational
\end{frame}

\begin{frame}[fragile]
\frametitle{Arithmetic}
Let us consider functions of the form:
\begin{align*}
\frac{ax + b}{cx + d}
\end{align*}
with $a,b,c,d$ all integers.
\begin{minted}{haskell}
type Hom = (Integer, Integer,
            Integer, Integer)

hom :: Hom -> [Integer] -> [Integer]
\end{minted}
\end{frame}

\begin{frame}[fragile]
Let $x = [x_0, ...] = x_0 + \frac{1}{x'}$, then:
\begin{align*}
\frac{ax + b}{cx + d} &= \frac{a(x_0 + \frac{1}{x'}) + b}{c(x_0 + \frac{1}{x'}) + d} \\
\uncover<2->{&= \frac{a(x_0 + \frac{1}{x'}) + b}{c(x_0 + \frac{1}{x'}) + d} \\}
\uncover<3->{&= \frac{ax_0 + a\frac{1}{x'} + b}{cx_0 + c\frac{1}{x'} + d}\\}
\uncover<4->{&= \frac{ax_0x' + a + bx'}{cx_0x' + c + dx'}}\\
\uncover<5->{&= \frac{(ax_0 + b)x' + a}{(cx_0 + d)x' + c}}
\end{align*}
\end{frame}

\begin{frame}[fragile]
\begin{minted}{haskell}
absorb :: Hom -> Integer -> Hom
absorb (a, b
        c, d) x0 = (a*x0 + b, a,
                    c*x0 + d, c)

hom h (x0:rest) == hom (absorb h x0) rest
\end{minted}
\end{frame}

\begin{frame}[fragile]
Let $z = \frac{ax + b}{cx + d}$. As $x \in [0, \infty]$,
$z$ must lie in $[\frac{a}{c}, \frac{b}{d}]$.
\\~\\
So if $\frac{a}{c}$ and $\frac{b}{d}$ have the same integer part $q$, we
know for sure that $z = [q,\dots]$.
\\~\\
\begin{minted}{haskell}
tryEmit :: Hom -> Maybe Integer
tryEmit (a, b
         c, d) = if c /= 0 && d /= 0 && r == s then
                   Just r
                 else
                   Nothing
  where r = a `quot` c
        s = b `quot` d
\end{minted}
\end{frame}

\begin{frame}[fragile]
Let $z = q + \frac{1}{z'}$, then:
\begin{align*}
z' &= (z - q)^{-1} \\
\uncover<2->{&= \left(\frac{ax + b}{cx + d} - q\right)^{-1} \\}
\uncover<3->{&= \left(\frac{(ax + b) - q(cx + d)}{cx + d}\right)^{-1} \\}
\uncover<4->{&= \left(\frac{(a - cq)x + (b - dq)}{cx + d}\right)^{-1} \\}
\uncover<5->{&= \frac{cx + d}{(a - cq)x + (b - dq)}}
\end{align*}
\end{frame}

\begin{frame}[fragile]
\begin{minted}{haskell}
emit :: Hom -> Integer -> Hom
emit (a, b
      c, d) q = (c,       d,
                 a - c*q, b - d*q)

hom h cf == q : hom (emit q h) cf
\end{minted}
\end{frame}

\begin{frame}[fragile]
\begin{minted}{haskell}
hom :: Hom -> Integer -> Integer
hom h (x:xs) = case tryEmit h of
                 Just d -> d : hom (homEmit h d) (x:xs)
                 Nothing ->    hom (homAbsorb h x) xs
\end{minted}
\end{frame}

\begin{frame}[fragile]
To do arithmetic, repeat all of the above with
\begin{align*}
\frac{axy + bx + cy + d}{exy + fx + gy + h}
\end{align*}
\begin{minted}{haskell}
type Bihom = (Integer, Integer, Integer, Integer,
              Integer, Integer, Integer, Integer)

bihom :: Bihom -> [Integer] -> [Integer] -> [Integer]
\end{minted}
Now we can absorb from either $x$ or $y$, and emit similar to before.
\end{frame}

\begin{frame}[fragile]
\begin{minted}{haskell}
  (+) = bihom (0, 1, 1, 0,
               0, 0, 0, 1)
  (*) = bihom (1, 0, 0, 0,
               0, 0, 0, 1)
...
\end{minted}
\end{frame}

\begin{frame}[fragile]
\frametitle{Transcendental functions}
\pause
\begin{align*}
e^x &= [1, \frac{1}{x}, -2, \frac{3}{x}, 2, \frac{5}{x}, -2, \dots] \\
~\\
\log x &= [0, \frac{1}{x-1}, \frac{2}{1}, \frac{3}{x-1}, \frac{2}{3}, \frac{5}{x-1}, \frac{2}{5}, \dots]
\end{align*}
\pause
\begin{minted}{haskell}
type Hom a = (a, a, a, a)

hom :: Hom a -> [a] -> [Integer]
\end{minted}
\end{frame}

\begin{frame}
\nocite{*}
\printbibliography
\end{frame}
\end{document}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
